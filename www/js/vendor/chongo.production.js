(function(){var h,t,u,v,w,x,n,C,q,y,D,E,z,k,p,f,r,F,l,A,G,g,s,H,I,m=[].indexOf||function(b){for(var a=0,d=this.length;a<d;a++)if(a in this&&this[a]===b)return a;return-1},J={}.hasOwnProperty,B=function(b,a){function d(){this.constructor=b}for(var c in a)J.call(a,c)&&(b[c]=a[c]);d.prototype=a.prototype;b.prototype=new d;b.__super__=a.prototype;return b};k=function(b,a){var d,c,e,g,f;c=b;f=a.split(".");e=0;for(g=f.length;e<g;e++)d=f[e],null!=c&&(c=c[d]);return c};p=function(b,a,d){var c,e,f,g;g=a.split(".");
a=0;for(f=g.length;a<f;a++)e=g[a],null==b[e]&&(b[e]={}),c=b,b=b[e];return c[e]=d};z=function(b,a){var d,c,e,g,f,h;e=b;h=a.split(".");g=0;for(f=h.length;g<f;g++)c=h[g],null==e[c]&&(e[c]={}),d=e,e=e[c];return delete d[c]};r={};F={$gt:function(b,a){return b>a},$gte:function(b,a){return b>=a},$in:function(b,a){return 0<=m.call(a,b)},$lt:function(b,a){return b<a},$lte:function(b,a){return b<=a},$ne:function(b,a){return b!==a},$nin:function(b,a){return 0>m.call(a,b)},$all:function(b,a){var d,c,e;c=0;for(e=
b.length;c<e;c++)if(d=b[c],0>m.call(a,d))return!1;return!0},$exists:function(b,a){return null!=b===a},$mod:function(b,a){return b%a[0]===a[1]},$size:function(b,a){return b.length===a},$elemMatch:function(b,a){var d,c,e;c=0;for(e=b.length;c<e;c++)if(d=b[c],r.$m(d,a))return!0;return!1},$m:function(b,a){var d,c;for(d in a)if(c=a[d],!this[d](b,c))return!1;return!0}};h={$or:function(b,a){var d,c,e;c=0;for(e=a.length;c<e;c++)if(d=a[c],this.$m(b,d))return!0;return!1},$and:function(b,a){var d,c,e;c=0;for(e=
a.length;c<e;c++)if(d=a[c],!this.$m(b,d))return!1;return!0},$not:function(b,a){return!this.$m(b,a)},$nor:function(b,a){var d,c,e;c=0;for(e=a.length;c<e;c++)if(d=a[c],this.$m(b,d))return!1;return!0},$m:function(b,a){var d;for(f in a)if(g=a[f],f in this?d=this[f](b,g):(d=k(b,f),d=g instanceof RegExp?g.test(d):g instanceof Object?"$"===Object.keys(g)[0][0]?F.$m(d,g):JSON.stringify(g)===JSON.stringify(d):Array.isArray(d)?0<=m.call(d,g):d===g),!d)return!1;return!0}};for(f in h)g=h[f],r[f]=g;q=function(b){return function(a){return r.$m(a,
b)}};A=function(b){var a;a=typeof b;return null===b?2:"number"===a?3:"string"===a?4:"boolean"===a?9:b instanceof n?8:b instanceof RegExp?11:b instanceof Array?6:5};s=function(){return 0};l=function(b,a){return b<a?-1:b>a?1:0};h=function(b,a){return l(JSON.stringify(b),JSON.stringify(a))};E=[null,s,s,l,l,h,h,l,l,l,l,l,s];D=function(b,a){var d,c;d=A(b);c=A(a);return d<c?-1:d>c?1:E[d](b,a)};u=function(b){return function(a,d){var c,e;for(f in b)if(g=b[f],c=a[f]||null,e=d[f]||null,c=D(c,e))return c;return 0}};
G={$inc:function(b,a,d){return p(b,a,d+k(b,a))},$rename:function(b,a,d){p(b,d,k(b,a));return z(b,a)},$setOnInsert:function(b,a,d,c){if(c)return p(b,a,d)},$set:function(b,a,d){return p(b,a,d)},$unset:function(b,a,d){return z(b,a)},$addToSet:function(b,a,d){var c,e,g,f;b=k(b,a);if(null!=d.$each){g=d.$each;f=[];c=0;for(e=g.length;c<e;c++)a=g[c],0>m.call(b,d)?f.push(b.push(a)):f.push(void 0);return f}if(0>m.call(b,d))return b.push(d)},$pop:function(b,a,d){b=k(b,a);return 0>d?b.shift():b.pop()},$pullAll:function(b,
a,d){var c,e,g,f;a=k(b,a);f=[];b=c=0;for(e=a.length;0<=e?c<e:c>e;b=0<=e?++c:--c)(g=a[b],0<=m.call(d,g))?(a.splice(b,1),f.push(b-1)):f.push(void 0);return f},$pull:function(b,a,d){var c,e,f;b=k(b,a);a=q(d);f=[];d=c=0;for(e=b.length;0<=e?c<e:c>e;d=0<=e?++c:--c)a(b[d])?(b.splice(d,1),f.push(d-1)):f.push(void 0);return f},$push:function(b,a,d){var c,e,f;b=k(b,a);if(null!=d.$each){f=d.$each;c=0;for(e=f.length;c<e;c++)a=f[c],b.push(a);null!=d.$sort&&(a=u(d.$sort),b.sort(a));return b.splice(0,b.length+d.$slice)}return b.push(d)}};
y=function(b,a,d){var c;c=[];for(f in a)g=a[f],c.push(G[b](d,f,g,!1));return c};C=function(b){var a,d,c;if(Array.isArray(b)){a=b;b={};d=0;for(c=a.length;d<c;d++)f=a[d],b[f]=1;a=null}return function(a){var d,c;if(!b)return a;c={};d=!1;for(f in b)if(g=b[f])d=!0,c[f]=a[f];if(!d)for(f in a)g=a[f],c[f]=g;c._id=a._id;for(f in b)(g=b[f])||delete c[f];return c}};n=function(){function b(a){null==a&&(a=null);this.v=null!=a?a:this.constructor.generate()}b.inc=~~(16777215*Math.random());b.hostname=b.inc;b.pid=
~~(16777215*Math.random());b.getInc=function(){g=this.inc;this.inc=(this.inc+1)%16777215;return g};b.generate=function(){g=this._pad("00000000",~~((new Date).getTime()/1E3));g+=this._pad("000000",this.hostname);g+=this._pad("0000",this.pid);return g+=this._pad("000000",this.getInc())};b.prototype.toString=function(){return'ObjectId("#{@v}")'};b.prototype.valueOf=function(){return this.v};b._pad=function(a,b){var c;c=b.toString(16);return(a+c).substring(c.length)};return b}();v=function(){function b(a,
b,c,e){this.col=a;this.index=b;this.query=c;this.projection=e;this.doc=null;this.done=this.started=!1;this.n=this.i=0;"string"===typeof this.query&&(this.query={_id:this.query})}b.prototype.load=function(){this.started=!0;this.match=q(this.query);return this.project=null!=this.projection?C(this.projection):function(a){return a}};b.prototype.fetch=function(){var a;this.started||this.load();for(this.doc=null;!(null!=this.doc||this.i>=this.index.length);)a=this.index[this.i++],this.doc=new x(this.col,
a),this.match(this.doc.data)||(this.doc=null);null!=this.doc?++this.n:this.done=!0;return this.doc};b.prototype.pop=function(){var a;if(null==this.doc)return null;this.index.splice(--this.i,1);a=this.doc;this.doc=null;return a};b.prototype.hasNext=function(){if(null!=this.doc)return!0;if(this.done)return!1;this.fetch();return!this.done};b.prototype.next=function(){var a;null==this.doc&&this.fetch();if(null==this.doc)throw Error("No more data.");a=this.doc.data;this.doc=null;return this.project(a)};
b.prototype.toArray=function(){var a;for(a=[];this.hasNext();)a.push(this.next());return a};b.prototype.count=function(){var a;for(a=0;this.hasNext();)a++,this.next();return a};b.prototype.update=function(a){var b,c;if(null==this.doc)throw TypeError();c=this.doc._id;b=Object.keys(a);if(null!=b[0]&&"$"!==b[0][0])for(f in this.doc.data={},a)g=a[f],this.doc.data[f]=g;else for(f in a)g=a[f],y(f,g,this.doc.data);this.doc.data._id=c;return this.doc.store()};return b}();h=function(){function b(a,b,c){this.con=
a;this._id=b;this.data=c;this.ns=".";null==this.data&&this.load()}b.prototype.load=function(){return this.data=this.get("")||{sub:[]}};b.prototype.store=function(){return this.set("",this.data)};b.prototype.destroy=function(){return this.del("")};b.prototype.get=function(a){return this.con.get(this.ns+this._id+a)};b.prototype.set=function(a,b){return this.con.set(this.ns+this._id+a,b)};b.prototype.del=function(a){return this.con.del(this.ns+this._id+a)};return b}();x=function(b){function a(a,b,e){this.con=
a;this._id=b;this.data=e;this.ns=".$$";null==this.data&&this.load()}B(a,b);return a}(h);t=function(b){function a(){return H=a.__super__.constructor.apply(this,arguments)}B(a,b);a.prototype.find=function(a,b){return new v(this,this.data.sub,a,b)};a.prototype.findOne=function(a,b){var e;e=new v(this,this.data.sub,a,b);try{return e.next()}catch(f){return null}};a.prototype.count=function(a){return this.find(a).count()};a.prototype.save=function(a){var b;b=Object.prototype.toString.call(a);if("[object Object]"!==
b)throw new TypeError("cannot save object of type "+b);if(0>m.call(a,"_id"))return this.insert(a);this.update({_id:a._id},a,True);return a.id||null};a.prototype.insert=function(a){var b,e,f;if(Array.isArray(a)){e=0;for(f=a.length;e<f;e++)b=a[e],b=this.insert(b);return b}null==a._id&&(a._id=(new n).valueOf());a=new x(this,a._id,a);a.store();this.data.sub.push(a._id.valueOf());this.store();return a._id};a.prototype.update=function(a,b,e){null==e&&(e=null);a=this.find(a);if(null!=e&&e.multi)for(;a.hasNext();)a.update(b),
a.fetch();else a.fetch(),a.update(b);return this.store()};a.prototype.remove=function(a){var b;for(a=this.find(a);a.hasNext();)b=a.pop(),b.destroy();return this.store()};a.prototype.count=function(){return this.data.sub.length};a.prototype.col=function(b){if("string"!==typeof b)throw TypeError;if(!/^[^.$\0]+(\.[^.$\0]+)*$/.test(b))throw RangeError;return new a(this,b)};a.prototype.drop=a.prototype.destroy;a.prototype.createIndex=function(a){throw NotImplemented;};return a}(h);w=function(b){function a(){return I=
a.__super__.constructor.apply(this,arguments)}B(a,b);a.prototype.col=function(a){var b;b=t.prototype.col.call(this,a);this.data.sub.push(a);return b};a.prototype.getCollectionNames=function(){return this.data.sub};a.prototype.dropCollection=function(a){return this.del(a)};return a}(h);h=this.Chongo={Connection:function(){function b(a){this.store=a;this.ns="$";this.data=this.get(".local.system.chongo");null==this.data&&(this.data={},this.data.hostname=n.hostname,this.set(".local.system.chongo",this.data))}
b.prototype.db=function(a){return new w(this,a)};b.prototype.get=function(a){console.log("Getting registry ",a);return(g=this.store.getItem(this.ns+a))&&JSON.parse(g)};b.prototype.set=function(a,b){console.log("Setting registry ",a," to value ",b);return this.store.setItem(this.ns+a,JSON.stringify(b))};b.prototype.del=function(a){return this.store.removeItem(this.ns+a)};return b}(),Database:w,Collection:t,Update:y,Compare:u,Query:q,ObjectId:n};"undefined"!==typeof module&&null!==module&&(module.exports=
h)}).call(this);
